version: '3.8'

services:
  # Nginx Reverse Proxy for multiple apps
  nginx-proxy:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./ssl:/etc/nginx/ssl:ro
    networks:
      - shared-network
    restart: unless-stopped

  # Matrimony Backend
  matrimony-app:
    build: .
    container_name: matrimony-backend
    environment:
      DB_URL: jdbc:mysql://matrimony-mysql:3306/matrimony_portal
      DB_USERNAME: bandhandb
      DB_PASSWORD: ${MATRIMONY_DB_PASSWORD:-bandhandb@123}
      JWT_SECRET: ${MATRIMONY_JWT_SECRET:-mySecretKey123456789012345678901234567890}
      SMTP_HOST: ${SMTP_HOST:-email-smtp.ap-south-1.amazonaws.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      APP_EMAIL_FROM: ${APP_EMAIL_FROM:-noreply@matrimony.com}
      SERVER_PORT: 8080
    expose:
      - "8080"
    volumes:
      - matrimony_uploads:/app/uploads
    networks:
      - shared-network
      - matrimony-network
    depends_on:
      matrimony-mysql:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  # Matrimony MySQL Database
  matrimony-mysql:
    image: mysql:8.0
    container_name: matrimony-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MATRIMONY_MYSQL_ROOT_PASSWORD:-root123}
      MYSQL_DATABASE: matrimony_portal
      MYSQL_USER: bandhandb
      MYSQL_PASSWORD: ${MATRIMONY_DB_PASSWORD:-bandhandb@123}
    volumes:
      - matrimony_mysql_data:/var/lib/mysql
    networks:
      - matrimony-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.3'

  # Shared phpMyAdmin for all MySQL instances
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: shared-phpmyadmin
    environment:
      PMA_ARBITRARY: 1
      PMA_HOST: matrimony-mysql
      PMA_USER: bandhandb
      PMA_PASSWORD: ${MATRIMONY_DB_PASSWORD:-bandhandb@123}
    expose:
      - "80"
    networks:
      - shared-network
      - matrimony-network
    restart: unless-stopped

volumes:
  matrimony_mysql_data:
  matrimony_uploads:

networks:
  shared-network:
    name: shared-network
    driver: bridge
  matrimony-network:
    driver: bridge